{% extends 'base.html' %}
{% block title %}图书列表{% endblock %}
{% block content %}
<div class="page-header">
  <h2>图书列表</h2>
</div>
<div class="action-toolbar">
  <div class="action-group">
    <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#importBooksModal">导入Excel</button>
    <a class="btn btn-sm btn-success" href="{{ url_for('books.export_books') }}">导出Excel</a>
  </div>
  <div class="action-group action-group-right">
    <a class="btn btn-sm btn-primary" href="{{ url_for('books.create_book') }}">新增图书</a>
  </div>
</div>
<div class="panel panel-default">
  <div class="panel-heading">
    <form class="form-inline" method="get">
      <div class="form-group">
        <input type="text" name="q" class="form-control input-sm" placeholder="搜索书名或ISBN" value="{{ filters.keyword }}">
      </div>
      <div class="form-group">
        <input type="text" name="call_number" class="form-control input-sm" placeholder="索书码" value="{{ filters.call_number }}">
      </div>
      <div class="form-group">
        <input type="text" name="position" class="form-control input-sm" placeholder="位置" value="{{ filters.position }}">
      </div>
      <div class="form-group">
        <select name="category_id" class="form-control input-sm">
          <option value="" {% if filters.category_id is none %}selected{% endif %}>全部分类</option>
          {% for item in category_options %}
          {% set option = item.category %}
          {% set indent = '&nbsp;&nbsp;&nbsp;&nbsp;' * item.depth %}
          {% set prefix = '└ ' if item.depth > 0 else '' %}
          <option value="{{ option.id }}" {% if filters.category_id == option.id %}selected{% endif %}>{{ indent|safe }}{{ prefix }}{{ option.name }}</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn btn-sm btn-primary" type="submit">搜索</button>
      <a class="btn btn-sm btn-default" href="{{ url_for('books.list_books') }}">重置</a>
    </form>
  </div>
  <table class="table table-striped table-condensed table-hover">
    <thead>
      <tr>
        <th>名称</th>
        <th>ISBN</th>
        <th>索书码</th>
        <th>分类</th>
        <th>库存</th>
        <th>已借出</th>
        <th>位置</th>
        <th>更新用户</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for book in books %}
      <tr>
        <td>{{ book.name }}</td>
        <td>{{ book.isbn }}</td>
        <td>{{ book.call_number or '-' }}</td>
        <td>{{ book.category.name if book.category else '未分类' }}</td>
        <td>{{ book.amount }}</td>
        <td>{{ book.lend_amount }}</td>
        <td>{{ book.position }}</td>
        <td>{{ book.updated_by.username if book.updated_by else '-' }}</td>
        <td>
          <a class="btn btn-xs btn-primary" href="{{ url_for('lending.borrow', isbn=book.isbn) }}">借出</a>
          <button class="btn btn-xs btn-default" data-toggle="collapse" data-target="#edit-{{ book.id }}">编辑</button>
          {% if current_user.level == 'admin' %}
          <form method="post" action="{{ url_for('books.delete_book', book_id=book.id) }}" style="display:inline" onsubmit="return confirm('确认删除?');">
            <button class="btn btn-xs btn-danger" type="submit">删除</button>
          </form>
          {% endif %}
        </td>
      </tr>
      <tr id="edit-{{ book.id }}" class="collapse">
        <td colspan="9">
          <form method="post" action="{{ url_for('books.update_book', book_id=book.id) }}" class="form-inline book-inline-form">
            <input type="text" name="name" value="{{ book.name }}" class="form-control input-sm" placeholder="名称" required>
            <input type="text" name="isbn" value="{{ book.isbn }}" class="form-control input-sm" placeholder="ISBN" required>
            <input type="text" name="call_number" value="{{ book.call_number }}" class="form-control input-sm" placeholder="索书码">
            <select name="category_id" class="form-control input-sm">
              <option value="">未分类</option>
              {% for item in category_options %}
              {% set option = item.category %}
              {% set indent = '&nbsp;&nbsp;&nbsp;&nbsp;' * item.depth %}
              {% set prefix = '└ ' if item.depth > 0 else '' %}
              <option value="{{ option.id }}" {% if book.category_id == option.id %}selected{% endif %}>{{ indent|safe }}{{ prefix }}{{ option.name }}</option>
              {% endfor %}
            </select>
            <input type="number" name="amount" value="{{ book.amount }}" class="form-control input-sm" style="width:100px" min="1" required>
            <input type="number" name="lend_amount" value="{{ book.lend_amount }}" class="form-control input-sm" style="width:100px" min="0">
            <input type="text" name="position" value="{{ book.position }}" class="form-control input-sm" placeholder="位置">
            <button type="submit" class="btn btn-sm btn-primary">保存</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="9" class="text-center text-muted">暂无数据</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<div class="modal fade" id="importBooksModal" tabindex="-1" role="dialog" aria-labelledby="importBooksModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" action="{{ url_for('books.import_books') }}" enctype="multipart/form-data">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="importBooksModalLabel">导入图书</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="book-file">选择文件</label>
            <input type="file" id="book-file" name="file" class="form-control" required>
          </div>
          <div class="checkbox">
            <label>
              <input type="checkbox" name="template_confirmed" value="1" required> 已下载模板并按要求填写
            </label>
          </div>
          <a class="btn btn-link" href="{{ url_for('books.download_import_template') }}">下载图书导入模板</a>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">确认导入</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">取消导入</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% include '_pagination.html' %}
{% endblock %}
