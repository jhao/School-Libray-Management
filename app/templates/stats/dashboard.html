{% extends 'base.html' %}
{% block title %}统计分析{% endblock %}
{% block content %}
<div class="row">
  <div class="col-xs-12">
    <form class="form-inline" method="get">
      <div class="form-group">
        <label>开始日期</label>
        <input type="date" name="start" value="{{ default_start }}" class="form-control input-sm">
      </div>
      <div class="form-group">
        <label>结束日期</label>
        <input type="date" name="end" value="{{ default_end }}" class="form-control input-sm">
      </div>
      <button type="submit" class="btn btn-sm btn-primary">刷新</button>
    </form>
  </div>
</div>
<hr>
<style>
  .inventory-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  .book-total-badge {
    background: #f0f5ff;
    color: #1f2d3d;
    font-size: 2.4rem;
    font-weight: 700;
    padding: 10px 24px;
    border-radius: 10px;
    box-shadow: inset 0 0 0 1px rgba(31, 45, 61, 0.1);
  }

  .filter-row {
    margin-bottom: 10px;
  }
</style>
<div class="row">
  <div class="col-md-6">
    <h4>借阅与归还趋势</h4>
    <canvas id="lendChart" height="200"></canvas>
  </div>
  <div class="col-md-6">
    <div class="inventory-header">
      <h4>图书库存情况</h4>
      <div class="book-total-badge">{{ book_total }}</div>
    </div>
    <p class="text-muted">当前库存统计展示所选时间范围内的图书总量。</p>
  </div>
</div>
<div class="row">
  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="panel-heading">最受欢迎TOP50</div>
      <table class="table table-condensed table-hover">
        <thead>
          <tr>
            <th>排名</th>
            <th>书名</th>
            <th>借阅总数</th>
          </tr>
        </thead>
        <tbody>
          {% for book in popular_books %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ book[0] }}</td>
            <td>{{ book[1] or 0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="col-md-6">
    <h4>图书借阅超期情况</h4>
    <ul class="list-group">
      <li class="list-group-item">超过1年未归还：<span class="badge">{{ overdue_1y }}</span></li>
      <li class="list-group-item">6-12个月未归还：<span class="badge">{{ overdue_6_12 }}</span></li>
      <li class="list-group-item">1-6个月未归还：<span class="badge">{{ overdue_6 }}</span></li>
      <li class="list-group-item">近一个月未归还：<span class="badge">{{ overdue_1m }}</span></li>
    </ul>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <h4>各年级班级借阅统计</h4>
    <div class="filter-row form-inline">
      <div class="form-group">
        <label for="gradeFilter">年级</label>
        <select id="gradeFilter" class="form-control input-sm">
          <option value="">全部</option>
        </select>
      </div>
      <div class="form-group" style="margin-left: 10px;">
        <label for="classFilter">班级</label>
        <select id="classFilter" class="form-control input-sm">
          <option value="">全部</option>
        </select>
      </div>
    </div>
    <table id="gradeStatsTable" class="table table-striped table-condensed table-hover">
      <thead>
        <tr>
          <th>年级</th>
          <th>班级</th>
          <th>总计借出</th>
          <th>总计归还</th>
        </tr>
      </thead>
      <tbody>
        {% for row in grade_stats %}
        <tr data-grade="{{ row.grade }}" data-class="{{ row.class }}">
          <td>{{ row.grade }}</td>
          <td>{{ row.class }}</td>
          <td>{{ row.lend_count }}</td>
          <td>{{ row.return_count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@1.1.1/Chart.min.js"></script>
<script>
(function() {
  var lendCtx = document.getElementById('lendChart').getContext('2d');
  var labels = [
    {% for date, count in lend_stats %}
      '{{ date }}',
    {% endfor %}
  ];
  var lendData = [
    {% for date, count in lend_stats %}
      {{ count }},
    {% endfor %}
  ];
  var returnLabels = [
    {% for date, count in return_stats %}
      '{{ date }}',
    {% endfor %}
  ];
  var returnData = [
    {% for date, count in return_stats %}
      {{ count }},
    {% endfor %}
  ];
  var dataMap = {};
  labels.forEach(function(label, index) { dataMap[label] = { lend: lendData[index], ret: 0 }; });
  returnLabels.forEach(function(label, index) {
    if (!dataMap[label]) { dataMap[label] = { lend: 0, ret: returnData[index] }; }
    else { dataMap[label].ret = returnData[index]; }
  });

  var startDate = '{{ default_start }}' ? new Date('{{ default_start }}T00:00:00') : null;
  var endDate = '{{ default_end }}' ? new Date('{{ default_end }}T00:00:00') : null;
  function formatDate(date) {
    var year = date.getFullYear();
    var month = ('0' + (date.getMonth() + 1)).slice(-2);
    var day = ('0' + date.getDate()).slice(-2);
    return [year, month, day].join('-');
  }

  if (!startDate || isNaN(startDate.getTime())) {
    var firstLabel = labels.concat(returnLabels).sort()[0];
    startDate = firstLabel ? new Date(firstLabel + 'T00:00:00') : new Date();
  }
  if (!endDate || isNaN(endDate.getTime())) {
    var lastLabelList = labels.concat(returnLabels).sort();
    var lastLabel = lastLabelList[lastLabelList.length - 1];
    endDate = lastLabel ? new Date(lastLabel + 'T00:00:00') : new Date();
  }

  var mergedLabels = [];
  var mergedLend = [];
  var mergedReturn = [];
  if (startDate && endDate) {
    for (var cursor = new Date(startDate); cursor <= endDate; cursor.setDate(cursor.getDate() + 1)) {
      var label = formatDate(cursor);
      var entry = dataMap[label] || { lend: 0, ret: 0 };
      mergedLabels.push(label);
      mergedLend.push(entry.lend || 0);
      mergedReturn.push(entry.ret || 0);
    }
  }

  new Chart(lendCtx).Line({
    labels: mergedLabels,
    datasets: [
      {
        label: '借出',
        fillColor: 'rgba(52,152,219,0.2)',
        strokeColor: '#3498db',
        pointColor: '#2980b9',
        data: mergedLend
      },
      {
        label: '归还',
        fillColor: 'rgba(46,204,113,0.2)',
        strokeColor: '#27ae60',
        pointColor: '#1e8449',
        data: mergedReturn
      }
    ]
  }, { responsive: true });
})();

(function() {
  var gradeSelect = document.getElementById('gradeFilter');
  var classSelect = document.getElementById('classFilter');
  var rows = Array.prototype.slice.call(document.querySelectorAll('#gradeStatsTable tbody tr'));

  var gradeSet = new Set();
  rows.forEach(function(row) {
    gradeSet.add(row.getAttribute('data-grade'));
  });

  Array.from(gradeSet).sort().forEach(function(grade) {
    if (gradeSelect && grade) {
      var option = document.createElement('option');
      option.value = grade;
      option.textContent = grade;
      gradeSelect.appendChild(option);
    }
  });

  function populateClasses(filterGrade) {
    var existing = Array.prototype.slice.call(classSelect.querySelectorAll('option'));
    existing.slice(1).forEach(function(opt) { opt.remove(); });
    var filteredClasses = new Set();
    rows.forEach(function(row) {
      var grade = row.getAttribute('data-grade');
      if (!filterGrade || grade === filterGrade) {
        filteredClasses.add(row.getAttribute('data-class'));
      }
    });
    Array.from(filteredClasses).sort().forEach(function(cls) {
      if (cls) {
        var option = document.createElement('option');
        option.value = cls;
        option.textContent = cls;
        classSelect.appendChild(option);
      }
    });
  }

  populateClasses('');

  function filterRows() {
    var gradeValue = gradeSelect.value;
    var classValue = classSelect.value;
    rows.forEach(function(row) {
      var matchGrade = !gradeValue || row.getAttribute('data-grade') === gradeValue;
      var matchClass = !classValue || row.getAttribute('data-class') === classValue;
      row.style.display = (matchGrade && matchClass) ? '' : 'none';
    });
  }

  gradeSelect.addEventListener('change', function() {
    populateClasses(gradeSelect.value);
    classSelect.value = '';
    filterRows();
  });

  classSelect.addEventListener('change', filterRows);

  filterRows();
})();
</script>
{% endblock %}
