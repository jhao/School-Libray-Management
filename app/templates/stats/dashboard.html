{% extends 'base.html' %}
{% block title %}统计分析{% endblock %}
{% block content %}
<div class="row">
  <div class="col-xs-12">
    <form class="form-inline" method="get">
      <div class="form-group">
        <label>开始日期</label>
        <input type="date" name="start" value="{{ default_start }}" class="form-control input-sm">
      </div>
      <div class="form-group">
        <label>结束日期</label>
        <input type="date" name="end" value="{{ default_end }}" class="form-control input-sm">
      </div>
      <button type="submit" class="btn btn-sm btn-primary">刷新</button>
    </form>
  </div>
</div>
<hr>
<style>
  .inventory-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  .stats-total-badge {
    background: #f0f5ff;
    color: #1f2d3d;
    font-size: 2.4rem;
    font-weight: 700;
    padding: 10px 24px;
    border-radius: 10px;
    box-shadow: inset 0 0 0 1px rgba(31, 45, 61, 0.1);
  }

  .filter-row {
    margin-bottom: 10px;
  }

  .popular-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .popular-pager {
    display: flex;
    align-items: center;
  }

  .pager-icon {
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
  }

  .pager-icon.disabled {
    cursor: not-allowed;
    opacity: 0.4;
  }
</style>
<div class="row">
  <div class="col-md-6">
    <h4>借阅与归还趋势</h4>
    <canvas id="lendChart" height="200"></canvas>
  </div>
  <div class="col-md-6">
    <div class="inventory-header">
      <h4>图书库存情况</h4>
      <div class="stats-total-badge">{{ book_inventory_total }}/{{ book_isbn_total }}</div>
    </div>
    <p class="text-muted">图书库存总册数 / 图书ISBN种类数量。</p>
    <div class="inventory-header">
      <h4>读者数据情况</h4>
      <div class="stats-total-badge">{{ reader_total }}/{{ active_reader_total }}</div>
    </div>
    <p class="text-muted">读者账户总数 / 当前有借阅的读者数。</p>
  </div>
</div>
<div class="row">
  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="panel-heading popular-header">
        <span>最受欢迎TOP50</span>
        <div class="popular-pager">
          <span class="pager-icon" id="popularPrev" title="前一页">
            <span class="glyphicon glyphicon-chevron-left"></span>
          </span>
          <span class="pager-icon" id="popularNext" title="后一页" style="margin-left: 6px;">
            <span class="glyphicon glyphicon-chevron-right"></span>
          </span>
        </div>
      </div>
      <table class="table table-condensed table-hover" id="popularBooksTable">
        <thead>
          <tr>
            <th>排名</th>
            <th>书名</th>
            <th>借阅总数</th>
          </tr>
        </thead>
        <tbody id="popularBooksBody"></tbody>
      </table>
    </div>
  </div>
  <div class="col-md-6">
    <h4>图书借阅超期情况</h4>
    <ul class="list-group">
      <li class="list-group-item">一个月内借出未归还：<span class="badge">{{ recent_unreturned }}</span></li>
      <li class="list-group-item">超过1年未归还：<span class="badge">{{ overdue_1y }}</span></li>
      <li class="list-group-item">6-12个月未归还：<span class="badge">{{ overdue_6_12 }}</span></li>
      <li class="list-group-item">1-6个月未归还：<span class="badge">{{ overdue_6 }}</span></li>
      <li class="list-group-item">近一个月未归还：<span class="badge">{{ overdue_1m }}</span></li>
    </ul>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <h4>各年级班级借阅统计</h4>
    <form class="filter-row form-inline" method="get">
      <input type="hidden" name="start" value="{{ request.args.get('start', '') }}">
      <input type="hidden" name="end" value="{{ request.args.get('end', '') }}">
      <div class="form-group">
        <label for="gradeFilter">年级</label>
        <select id="gradeFilter" class="form-control input-sm">
          <option value="">全部</option>
        </select>
      </div>
      <div class="form-group" style="margin-left: 10px;">
        <label for="classFilter">班级</label>
        <select id="classFilter" class="form-control input-sm">
          <option value="">全部</option>
        </select>
      </div>
      <div class="form-group" style="margin-left: 10px;">
        <label for="gradeStart">开始日期</label>
        <input type="date" id="gradeStart" name="grade_start" value="{{ grade_start or '' }}" class="form-control input-sm">
      </div>
      <div class="form-group" style="margin-left: 10px;">
        <label for="gradeEnd">结束日期</label>
        <input type="date" id="gradeEnd" name="grade_end" value="{{ grade_end or '' }}" class="form-control input-sm">
      </div>
      <button type="submit" class="btn btn-sm btn-primary" style="margin-left: 10px;">筛选</button>
    </form>
    <table id="gradeStatsTable" class="table table-striped table-condensed table-hover">
      <thead>
        <tr>
          <th>年级</th>
          <th>班级</th>
          <th>总计借出</th>
          <th>总计归还</th>
        </tr>
      </thead>
      <tbody>
        {% for row in grade_stats %}
        <tr data-grade="{{ row.grade }}" data-class="{{ row.class }}">
          <td>{{ row.grade }}</td>
          <td>{{ row.class }}</td>
          <td>{{ row.lend_count }}</td>
          <td>{{ row.return_count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@1.1.1/Chart.min.js"></script>
<script>
(function() {
  var popularBooks = {{ popular_books|tojson }};
  var popularPageSize = 10;
  var popularCurrentPage = 1;
  var popularBody = document.getElementById('popularBooksBody');
  var popularPrev = document.getElementById('popularPrev');
  var popularNext = document.getElementById('popularNext');

  function renderPopularPage() {
    var start = (popularCurrentPage - 1) * popularPageSize;
    var end = Math.min(start + popularPageSize, popularBooks.length);
    var rows = [];
    for (var i = start; i < end; i++) {
      var book = popularBooks[i];
      rows.push('<tr>' +
        '<td>' + (i + 1) + '</td>' +
        '<td>' + (book.name || '') + '</td>' +
        '<td>' + (book.total || 0) + '</td>' +
        '</tr>');
    }
    popularBody.innerHTML = rows.join('');
    updatePagerState();
  }

  function updatePagerState() {
    if (popularCurrentPage <= 1) {
      popularPrev.classList.add('disabled');
    } else {
      popularPrev.classList.remove('disabled');
    }

    if (popularCurrentPage * popularPageSize >= popularBooks.length) {
      popularNext.classList.add('disabled');
    } else {
      popularNext.classList.remove('disabled');
    }
  }

  if (popularPrev && popularNext) {
    popularPrev.addEventListener('click', function() {
      if (popularCurrentPage > 1) {
        popularCurrentPage--;
        renderPopularPage();
      }
    });

    popularNext.addEventListener('click', function() {
      if (popularCurrentPage * popularPageSize < popularBooks.length) {
        popularCurrentPage++;
        renderPopularPage();
      }
    });
  }

  renderPopularPage();

  var lendCtx = document.getElementById('lendChart').getContext('2d');
  var labels = [
    {% for date, count in lend_stats %}
      '{{ date }}',
    {% endfor %}
  ];
  var lendData = [
    {% for date, count in lend_stats %}
      {{ count }},
    {% endfor %}
  ];
  var returnLabels = [
    {% for date, count in return_stats %}
      '{{ date }}',
    {% endfor %}
  ];
  var returnData = [
    {% for date, count in return_stats %}
      {{ count }},
    {% endfor %}
  ];
  var dataMap = {};
  labels.forEach(function(label, index) { dataMap[label] = { lend: lendData[index], ret: 0 }; });
  returnLabels.forEach(function(label, index) {
    if (!dataMap[label]) { dataMap[label] = { lend: 0, ret: returnData[index] }; }
    else { dataMap[label].ret = returnData[index]; }
  });

  var startDate = '{{ default_start }}' ? new Date('{{ default_start }}T00:00:00') : null;
  var endDate = '{{ default_end }}' ? new Date('{{ default_end }}T00:00:00') : null;
  function formatDate(date) {
    var year = date.getFullYear();
    var month = ('0' + (date.getMonth() + 1)).slice(-2);
    var day = ('0' + date.getDate()).slice(-2);
    return [year, month, day].join('-');
  }

  if (!startDate || isNaN(startDate.getTime())) {
    var firstLabel = labels.concat(returnLabels).sort()[0];
    startDate = firstLabel ? new Date(firstLabel + 'T00:00:00') : new Date();
  }
  if (!endDate || isNaN(endDate.getTime())) {
    var lastLabelList = labels.concat(returnLabels).sort();
    var lastLabel = lastLabelList[lastLabelList.length - 1];
    endDate = lastLabel ? new Date(lastLabel + 'T00:00:00') : new Date();
  }

  var mergedLabels = [];
  var mergedLend = [];
  var mergedReturn = [];
  if (startDate && endDate) {
    for (var cursor = new Date(startDate); cursor <= endDate; cursor.setDate(cursor.getDate() + 1)) {
      var label = formatDate(cursor);
      var entry = dataMap[label] || { lend: 0, ret: 0 };
      mergedLabels.push(label);
      mergedLend.push(entry.lend || 0);
      mergedReturn.push(entry.ret || 0);
    }
  }

  new Chart(lendCtx).Line({
    labels: mergedLabels,
    datasets: [
      {
        label: '借出',
        fillColor: 'rgba(52,152,219,0.2)',
        strokeColor: '#3498db',
        pointColor: '#2980b9',
        data: mergedLend
      },
      {
        label: '归还',
        fillColor: 'rgba(46,204,113,0.2)',
        strokeColor: '#27ae60',
        pointColor: '#1e8449',
        data: mergedReturn
      }
    ]
  }, { responsive: true });
})();

(function() {
  var gradeSelect = document.getElementById('gradeFilter');
  var classSelect = document.getElementById('classFilter');
  var rows = Array.prototype.slice.call(document.querySelectorAll('#gradeStatsTable tbody tr'));

  var gradeSet = new Set();
  rows.forEach(function(row) {
    gradeSet.add(row.getAttribute('data-grade'));
  });

  Array.from(gradeSet).sort().forEach(function(grade) {
    if (gradeSelect && grade) {
      var option = document.createElement('option');
      option.value = grade;
      option.textContent = grade;
      gradeSelect.appendChild(option);
    }
  });

  function populateClasses(filterGrade) {
    var existing = Array.prototype.slice.call(classSelect.querySelectorAll('option'));
    existing.slice(1).forEach(function(opt) { opt.remove(); });
    var filteredClasses = new Set();
    rows.forEach(function(row) {
      var grade = row.getAttribute('data-grade');
      if (!filterGrade || grade === filterGrade) {
        filteredClasses.add(row.getAttribute('data-class'));
      }
    });
    Array.from(filteredClasses).sort().forEach(function(cls) {
      if (cls) {
        var option = document.createElement('option');
        option.value = cls;
        option.textContent = cls;
        classSelect.appendChild(option);
      }
    });
  }

  populateClasses('');

  function filterRows() {
    var gradeValue = gradeSelect.value;
    var classValue = classSelect.value;
    rows.forEach(function(row) {
      var matchGrade = !gradeValue || row.getAttribute('data-grade') === gradeValue;
      var matchClass = !classValue || row.getAttribute('data-class') === classValue;
      row.style.display = (matchGrade && matchClass) ? '' : 'none';
    });
  }

  gradeSelect.addEventListener('change', function() {
    populateClasses(gradeSelect.value);
    classSelect.value = '';
    filterRows();
  });

  classSelect.addEventListener('change', filterRows);

  filterRows();
})();
</script>
{% endblock %}
