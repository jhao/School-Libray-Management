{% extends 'base.html' %}
{% block title %}借书管理{% endblock %}
{% block content %}
<div class="row">
  <div class="col-sm-4 col-md-3">
    <h4>借书操作</h4>
    <form method="post" id="borrow-form" data-records-url="{{ url_for('lending.borrow_records') }}">
      <div class="form-group">
        <label>读者卡号</label>
        <input type="text" name="card_no" class="form-control" required>
      </div>
      <div class="form-group">
        <label>ISBN</label>
        <input type="text" name="isbn" class="form-control" value="{{ isbn_prefill }}" required>
      </div>
      <div class="form-group">
        <label>数量</label>
        <input type="number" name="amount" class="form-control" value="1" min="1">
      </div>
      <div class="form-group">
        <label>借阅天数</label>
        <input type="number" name="due_days" class="form-control" value="30" min="1">
      </div>
      <button type="submit" class="btn btn-primary btn-block">确认借书</button>
    </form>
  </div>
  <div class="col-sm-8 col-md-9">
    <h4>最近借阅记录</h4>
    <table class="table table-striped table-condensed table-hover">
      <thead>
        <tr>
          <th>时间</th>
          <th>读者</th>
          <th>图书</th>
          <th>数量</th>
          <th>应还日期</th>
          <th>借出操作人</th>
          <th>状态</th>
        </tr>
      </thead>
      <tbody>
        {% for lend in lends %}
        <tr>
          <td>{{ lend.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ lend.reader.name }} ({{ lend.reader.card_no }})</td>
          <td>{{ lend.book.name }} ({{ lend.book.isbn }})</td>
          <td>{{ lend.amount }}</td>
          {% if lend.due_date %}
          {% set due_class = '' %}
          {% if lend.status == 'returned' %}
            {% set due_class = 'due-returned' %}
          {% else %}
            {% set days_diff = (lend.due_date.date() - current_time.date()).days %}
            {% if days_diff >= 30 %}
              {% set due_class = 'due-safe' %}
            {% elif days_diff >= 10 %}
              {% set due_class = 'due-warning' %}
            {% elif days_diff >= 0 %}
              {% set due_class = 'due-urgent' %}
            {% else %}
              {% set due_class = 'due-overdue' %}
            {% endif %}
          {% endif %}
          <td>
            <span class="due-label {{ due_class }}">{{ lend.due_date.strftime('%Y-%m-%d') }}</span>
          </td>
          {% else %}
          <td>—</td>
          {% endif %}
          <td>{{ lend.borrow_operator.username if lend.borrow_operator else '—' }}</td>
          <td>{{ '已归还' if lend.status == 'returned' else '借出中' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('borrow-form');
    if (!form) {
      return;
    }
    var isbnInput = form.querySelector('input[name="isbn"]');
    var submitButton = form.querySelector('button[type="submit"]');
    if (isbnInput && submitButton) {
      isbnInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          submitButton.focus();
        }
      });
    }

    var cardInput = form.querySelector('input[name="card_no"]');
    var recordsUrl = form.getAttribute('data-records-url');
    var tableBody = document.querySelector('.table.table-striped tbody');
    if (!cardInput || !recordsUrl || !tableBody) {
      return;
    }

    var lastFetchedCardNo = '';

    function renderRecords(lends) {
      tableBody.innerHTML = '';
      if (!Array.isArray(lends) || lends.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 7;
        emptyCell.className = 'text-center text-muted';
        emptyCell.textContent = '暂无借阅记录';
        emptyRow.appendChild(emptyCell);
        tableBody.appendChild(emptyRow);
        return;
      }

      lends.forEach(function(lend) {
        var row = document.createElement('tr');

        var createdAtCell = document.createElement('td');
        createdAtCell.textContent = lend.created_at || '—';
        row.appendChild(createdAtCell);

        var readerCell = document.createElement('td');
        readerCell.textContent = lend.reader || '—';
        row.appendChild(readerCell);

        var bookCell = document.createElement('td');
        bookCell.textContent = lend.book || '—';
        row.appendChild(bookCell);

        var amountCell = document.createElement('td');
        amountCell.textContent = lend.amount != null ? lend.amount : '—';
        row.appendChild(amountCell);

        var dueCell = document.createElement('td');
        if (lend.due_date) {
          var dueSpan = document.createElement('span');
          dueSpan.className = 'due-label' + (lend.due_class ? ' ' + lend.due_class : '');
          dueSpan.textContent = lend.due_date;
          dueCell.appendChild(dueSpan);
        } else {
          dueCell.textContent = '—';
        }
        row.appendChild(dueCell);

        var operatorCell = document.createElement('td');
        operatorCell.textContent = lend.borrow_operator || '—';
        row.appendChild(operatorCell);

        var statusCell = document.createElement('td');
        statusCell.textContent = lend.status_text || '—';
        row.appendChild(statusCell);

        tableBody.appendChild(row);
      });
    }

    function fetchRecords(cardNo) {
      var trimmed = cardNo.trim();
      if (trimmed === lastFetchedCardNo) {
        return;
      }
      var url = recordsUrl;
      if (trimmed) {
        url += '?card_no=' + encodeURIComponent(trimmed);
      }
      fetch(url, {
        headers: {
          'Accept': 'application/json'
        }
      })
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Failed to fetch records');
          }
          return response.json();
        })
        .then(function(data) {
          if (!data || !Array.isArray(data.lends)) {
            return;
          }
          renderRecords(data.lends);
          lastFetchedCardNo = trimmed;
        })
        .catch(function(error) {
          console.error(error);
        });
    }

    cardInput.addEventListener('blur', function() {
      fetchRecords(cardInput.value);
    });

    cardInput.addEventListener('input', function() {
      if (cardInput.value.trim() === '') {
        fetchRecords('');
      }
    });
  });
</script>
{% endblock %}
